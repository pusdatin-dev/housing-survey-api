name: ğŸš€ Deploy to Housing Survey Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Setup SSH key from base64 secret
        run: |
          mkdir -p ~/.ssh

          echo "${{ secrets.DEPLOY_SSH_PRIVATE_KEY_B64 }}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          echo "ğŸ’¡ Creating SSH config with IdentitiesOnly..."
          cat <<EOF > ~/.ssh/config
          Host remote
            HostName ${{ secrets.DEPLOY_HOST }}
            Port ${{ secrets.DEPLOY_PORT }}
            User ${{ secrets.DEPLOY_USER }}
            IdentityFile ~/.ssh/deploy_key
            IdentitiesOnly yes
            StrictHostKeyChecking no
          EOF

          chmod 600 ~/.ssh/config
          unset SSH_AUTH_SOCK

          echo "ğŸ” Adding server to known_hosts..."
          ssh-keyscan -p ${{ secrets.DEPLOY_PORT }} ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ” Test SSH connection
        run: |
          ssh remote "echo 'âœ… SSH connection successful'"

      - name: ğŸ” Rsync project files to server
        run: |
          rsync -az --delete \
            -e "ssh remote" \
            ./ remote:${{ secrets.DEPLOY_PATH }}

      - name: ğŸš€ Restart Docker Compose with graceful shutdown
        run: |
          ssh remote << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PATH }}
            echo "[1/3] ğŸ›‘ Gracefully stopping existing containers..."
            docker compose down --remove-orphans

            echo "[2/3] ğŸ”„ Starting containers..."
            docker compose up --build -d

            echo "[3/3] ğŸ©º Waiting for app health check..."
            for i in {1..10}; do
              if curl -s --fail http://localhost:8080/health > /dev/null; then
                echo "âœ… App healthy after deploy"
                exit 0
              fi
              echo "Waiting for app to be healthy ($i)..."
              sleep 3
            done

            echo "âŒ App failed health check after deploy"
            docker compose logs
            exit 1
          EOF
