name: Deploy to Housing Survey Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH key from base64 secret
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_PRIVATE_KEY_B64 }}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.DEPLOY_PORT }} ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Rsync project files to server
        run: |
          rsync -az --delete \
            -e "ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes -p ${{ secrets.DEPLOY_PORT }}" \
            ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}

      - name: Restart Docker Compose on remote server with graceful shutdown
        run: |
          ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes -p ${{ secrets.DEPLOY_PORT }} \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}
            echo "[1/3] Gracefully stopping existing containers..."
            docker compose down --remove-orphans
            echo "[2/3] Starting new containers..."
            docker compose up --build -d
            echo "[3/3] Waiting for app health check..."
            sleep 5
            for i in {1..10}; do
              curl -s --fail http://localhost:8080/health && echo "✅ App healthy" && exit 0
              echo "Waiting for app to be healthy ($i)..."
              sleep 3
            done
            echo "❌ App failed health check after deploy"
            exit 1
          EOF
